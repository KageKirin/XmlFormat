<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="ILRepacker" AfterTargets="Build">

    <Message Text="Repacking $(PublishDir)" Importance="high" />

    <PropertyGroup>
      <PublishedMainAssembly>$(PublishDir)$(AssemblyName).dll</PublishedMainAssembly>
    </PropertyGroup>

    <ItemGroup>
      <InputAssemblies Include="$(PublishedMainAssembly)" />
      <InputAssemblies Include="$(PublishDir)*.dll" Exclude="$(PublishedMainAssembly)" />

      <LibraryPath Include="$(PublishDir)" />
    </ItemGroup>

    <ItemGroup>
      <DoNotInternalizeAssemblies Include="$(PublishedMainAssembly)" />
    </ItemGroup>

    <Message Text="Repacking assemblies in $(PublishDir): @(InputAssemblies) ..." Importance="high" />
    <ILRepack
      Parallel="true"
      DebugInfo="true"
      Internalize="true"
      RenameInternalized="false"
      InputAssemblies="@(InputAssemblies)"
      InternalizeExclude="@(DoNotInternalizeAssemblies)"
      LibraryPath="@(LibraryPath)"
      TargetKind="SameAsPrimaryAssembly"

      OutputFile="$(PublishedMainAssembly)"
      LogFile="$(PublishDir)$(AssemblyName).ilrepack.log"
    />

    <ItemGroup>
      <FilesToDelete Include="$(PublishDir)*.dll" Exclude="$(PublishedMainAssembly)" />
      <FilesToDelete Include="$(PublishDir)*.pdb" Exclude="$(PublishDir)$(TargetName).pdb" />
      <FilesToDelete Include="$(PublishDir)*.deps.json" />
    </ItemGroup>

    <Message Text="Cleaning up merged files: @(FilesToDelete)" Importance="normal" />
    <Delete Files="@(FilesToDelete)" />

  </Target>


</Project>
